// public/upload.js
(function () {
  const $ = (id) => document.getElementById(id);

  const els = {
    file: $("file"),
    fileName: $("fileName"),
    debug: $("debug"),
    saida: $("saida"),
    vendedor: $("vendedor"),
    nomeCliente: $("nomeCliente"),
    numeroNotaFiscal: $("numeroNotaFiscal"),
    dataEmissao: $("dataEmissao"),
    formaEnvio: $("formaEnvio"),
    valorEnvio: $("valorEnvio"),
    pacote: $("pacote"),
    formaPagamento: $("formaPagamento"),
    enderecoLocal: $("enderecoLocal"),
    cep: $("cep"),
    valorTotalNota: $("valorTotalNota"),

    btnProcessar: $("btnProcessar"),
    btnSalvar: $("btnSalvar"),

    statusFile: $("statusFile"),
    statusParse: $("statusParse"),
    statusSave: $("statusSave"),
  };

  function setStatus(el, text, kind) {
    if (!el) return;
    el.textContent = text || "—";
    el.className = "v " + (kind || "");
  }

  function setOut(text) {
    if (els.saida) els.saida.textContent = text || "";
  }

  async function me() {
    const res = await fetch("/api/me", {
      credentials: "include",
      cache: "no-store",
      headers: { "Cache-Control": "no-cache", Pragma: "no-cache" },
    });
    const data = await res.json().catch(() => ({}));
    return { res, data };
  }

  async function requireLogin() {
    const { res, data } = await me().catch(() => ({ res: null, data: null }));
    if (!res || !res.ok || !data?.ok || !data?.authed) {
      // manda pro login mantendo retorno
      location.href = "/?next=/upload";
      return false;
    }
    return true;
  }

  function fillFields(fields) {
    els.nomeCliente.value = fields.nomeCliente || "";
    els.numeroNotaFiscal.value = fields.numeroNotaFiscal || "";
    els.dataEmissao.value = fields.dataEmissao || "";
    els.formaEnvio.value = fields.formaEnvio || "";
    els.valorEnvio.value = fields.valorEnvio || "";
    els.pacote.value = fields.pacote || "";
    els.formaPagamento.value = fields.formaPagamento || "";
    els.enderecoLocal.value = fields.enderecoLocal || "";
    els.cep.value = fields.cep || "";
    els.valorTotalNota.value = fields.valorTotalNota || "";

    if (els.debug) els.debug.textContent = fields.__debugTextPreview || "";
  }

  function readPayload() {
    return {
      vendedor: String(els.vendedor.value || "").trim(),
      nomeCliente: String(els.nomeCliente.value || "").trim(),
      numeroNotaFiscal: String(els.numeroNotaFiscal.value || "").trim(),
      dataEmissao: String(els.dataEmissao.value || "").trim(),
      formaEnvio: String(els.formaEnvio.value || "").trim(),
      valorEnvio: String(els.valorEnvio.value || "").trim(),
      pacote: String(els.pacote.value || "").trim(),
      formaPagamento: String(els.formaPagamento.value || "").trim(),
      enderecoLocal: String(els.enderecoLocal.value || "").trim(),
      cep: String(els.cep.value || "").trim(),
      valorTotalNota: String(els.valorTotalNota.value || "").trim(),
    };
  }

  // Atualiza nome do arquivo
  els.file?.addEventListener("change", () => {
    const f = els.file.files?.[0];
    els.fileName.textContent = f ? f.name : "—";
    setStatus(els.statusFile, f ? "Selecionado" : "—", f ? "ok" : "");
    setStatus(els.statusParse, "—", "");
    setStatus(els.statusSave, "—", "");
    setOut("");
    if (els.debug) els.debug.textContent = "";
  });

  // Processar PDF (usa /api/parse)
  els.btnProcessar?.addEventListener("click", async () => {
    if (!(await requireLogin())) return;

    const f = els.file.files?.[0];
    if (!f) {
      setStatus(els.statusFile, "Selecione um PDF", "warn");
      return;
    }

    els.btnProcessar.disabled = true;
    setStatus(els.statusParse, "Processando…", "warn");
    setOut("");

    try {
      const fd = new FormData();
      fd.append("file", f);

      const res = await fetch("/api/parse", {
        method: "POST",
        body: fd,
        credentials: "include",
      });

      if (res.status === 401) {
        setStatus(els.statusParse, "Sessão expirada", "warn");
        location.href = "/?next=/upload";
        return;
      }

      const data = await res.json().catch(() => null);

      if (!res.ok || !data?.ok) {
        setStatus(els.statusParse, "Falha", "bad");
        setOut((data && (data.error || data.details)) ? (data.error || data.details) : `Erro HTTP ${res.status}`);
        return;
      }

      fillFields(data.fields || {});
      setStatus(els.statusParse, "OK", "ok");
      setOut("Campos extraídos. Revise e clique em Salvar.");
    } catch (e) {
      setStatus(els.statusParse, "Falha (rede)", "bad");
      setOut(String(e?.message || e));
    } finally {
      els.btnProcessar.disabled = false;
    }
  });

  // Salvar no banco
  els.btnSalvar?.addEventListener("click", async () => {
    if (!(await requireLogin())) return;

    const payload = readPayload();
    if (!payload.vendedor) {
      setStatus(els.statusSave, "Vendedor obrigatório", "warn");
      return;
    }

    els.btnSalvar.disabled = true;
    setStatus(els.statusSave, "Salvando…", "warn");
    setOut("");

    try {
      const res = await fetch("/api/notas", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(payload),
      });

      if (res.status === 401) {
        setStatus(els.statusSave, "Sessão expirada", "warn");
        location.href = "/?next=/upload";
        return;
      }

      const data = await res.json().catch(() => null);

      if (!res.ok || !data?.ok) {
        setStatus(els.statusSave, "Falha", "bad");
        setOut((data && (data.error || data.details)) ? (data.error || data.details) : `Erro HTTP ${res.status}`);
        return;
      }

      setStatus(els.statusSave, "OK", "ok");
      setOut(`Salvo! ID: ${data.nota?.id ?? "—"} • NF: ${data.nota?.numero_nota_fiscal ?? "—"}`);
    } catch (e) {
      setStatus(els.statusSave, "Falha (rede)", "bad");
      setOut(String(e?.message || e));
    } finally {
      els.btnSalvar.disabled = false;
    }
  });
})();
